<!DOCTYPE html>
<html>
<head>
    <title>Test Page</title>
</head>
<body>
    <input type="number" id="quantity" />
    <select id="type">
        <option value="tsp">tsp</option>
        <option value="tbsp">tbsp</option>
        <option value="fl oz">fl oz</option>
        <option value="cup">cup</option>
        <option value="pt">pt</option>
        <option value="qt">qt</option>
        <option value="gal">gal</option>
    </select>
    <button type="button" id="convert-button">Convert</button>
    <p id="output"></p>

    <script>
        const conversions = {
            tsp: {
                up: {
                    type: "tbsp",
                    factor: (1 / 3)
                }
            },
            tbsp: {
                down: {
                    type: "tsp",
                    factor: 3
                },
                up: {
                    type: "fl oz",
                    factor: 0.5
                }
            },
            "fl oz": {
                down: {
                    type: "tbsp",
                    factor: 2
                },
                up: {
                    type: "cup",
                    factor: 0.125
                }
            },
            cup: {
                down: {
                    type: "fl oz",
                    factor: 8
                },
                up: {
                    type: "pt",
                    factor: 0.5
                }
            },
            pt: {
                down: {
                    type: "cup",
                    factor: 2
                },
                up: {
                    type: "qt",
                    factor: 0.5
                }
            },
            qt: {
                down: {
                    type: "pt",
                    factor: 2
                },
                up: {
                    type: "gal",
                    factor: 0.25
                }
            },
            gal: {
                down: {
                    type: "qt",
                    factor: 4
                }
            }
        };

        const convertDown = (quantity, type) => {
            let currentQuantity = quantity;
            let currentType = type;

            while (currentType !== "tsp") {
                const conversion = conversions[currentType].down;
                currentQuantity *= conversion.factor;
                currentType = conversion.type;
            }

            return currentQuantity;
        }

        const convertUp = (quantity, type) => {
            let outStrings = [];

            let currentQuantity = quantity;
            let currentType = type;

            let previousQuantity;
            let previousType;

            // Convert up from teaspoons until we have a value less than one.
            while (currentQuantity >= 1 && currentType !== "gal") {
                previousQuantity = currentQuantity;
                previousType = currentType;
                const conversion = conversions[currentType].up;
                currentQuantity *= conversion.factor;
                currentType = conversion.type;
            }

            // If we overshot, back up a bit.
            if (currentQuantity < 1) {
                currentQuantity = previousQuantity;
                currentType = previousType;
            }

            // Add it to the output.
            outStrings.push(`${Math.trunc(currentQuantity)} ${currentType}`);

            // Then pull off the part we just output.
            currentQuantity -= Math.trunc(currentQuantity);

            // Then, convert down to teaspoons until we get an even number.
            while (currentQuantity !== 0 && currentType !== "tsp") {
                const conversion = conversions[currentType].down;
                currentQuantity *= conversion.factor;
                currentType = conversion.type;
                if (currentQuantity >= 1) {
                    outStrings.push(`${Math.trunc(currentQuantity)} ${currentType}`)
                    currentQuantity -= Math.trunc(currentQuantity)
                }
            }

            // If we still have some left, they're teaspoons.
            if (currentQuantity > 0) {
                outStrings.push(`${currentQuantity} tsp`)
            }

            if (outStrings.length === 1) {
                return outStrings[0]
            }
            else if (outStrings.length === 2) {
                return `${outStrings[0]} and ${outStrings[1]}`
            }
            else {
                return `${outStrings.slice(0, -1).join(", ")}, and ${outStrings.slice(-1)}`;
            }
        }

        const output = document.getElementById("output");
        const convertButton = document.getElementById("convert-button");
        convertButton.onclick = () => {
            const quantity = Number(document.getElementById("quantity").value);
            const type = document.getElementById("type").value;

            const upConversion = convertUp(quantity, type);

            output.textContent = `${convertDown(quantity, type)} tsp OR ${upConversion}`
        }
    </script>
</body>
</html>
